#!/usr/bin/env bash

HOST="$1"
OPEN_URL_REMOTE_PORT=49634
LOG=/dev/null
BROWSER_COMMAND=${2:-firefox}
I3_WORKSPACE=${3:-1}

SOCKET_NAME=.remote-emacs-browser-`current-time-millis`.sock

listen_for_open_url_requests(){
    set -e
    nc -d -k -l 49634 2>>$LOG |
        grep --line-buffered -oP '^http\S*' |
        while [ 1 ]; do
            if read -t 5 REQ; then
                echo "[$$] Read \"$REQ\"" >> $LOG
                i3-msg workspace $I3_WORKSPACE      | sed "s/^/[$$] /" >> $LOG 2>&1
                i3-msg exec "$BROWSER_COMMAND $REQ" | sed "s/^/[$$] /" >> $LOG 2>&1
            else
                if [ $? -eq 1 ]; then
                    break
                fi
            fi
        done
}

listen_for_open_url_requests &

# is this even necessary?
URL_PID=$!
trap "kill $URL_PID" EXIT

ssh -R ~/$SOCKET_NAME:localhost:49634 -X -A "$HOST" -t /usr/bin/env bash -l -c $'
  # Kill/cleanup other connections
  PID=`cat ~/.remote-emacs.pid`
  if [ ! -z "$PID" ]; then
    if pstree $PID | grep -q emacsclient; then
      kill $PID
    fi
  fi

  # cleanup old sockets
  ls ~/.remote-emacs-browser*.sock | sort | head -n -1 | xargs rm

  echo $DISPLAY > ~/.xclip-display-fallback
  echo $$ > ~/.remote-emacs.pid
  export PATH=/home/gary/bin/emacs.bin:$PATH
  emacsclient -c -e \'(restore-longrunning-workgroup-setup)\'
  # For some reason, making emacsclient not the last thing causes
  # the server not to crash when we kill the client O_O
  date > /tmp/this-should-not-be-necessary
'
