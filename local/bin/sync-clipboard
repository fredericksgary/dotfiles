#!/usr/bin/env bash

# Coordinates with the `cbr` and `cbw`
# scripts elsewhere in this repo.

HOST="$1"

ssh \
    -nNT \
    -R 33041:localhost:33041 \
    "$HOST" > /dev/null 2>/dev/null &

FILE=`mktemp`
while true; do
  nc -l 33041 > "$FILE"
  cat "$FILE" | xsel -i -b
done > /dev/null 2> /dev/null &

trap 'kill $(jobs -p)' EXIT

LAST_PASTE=`xsel -b`
while true; do
  sleep 0.250;
  NEXT_PASTE=`xsel -b`
  if [ "$LAST_PASTE" != "$NEXT_PASTE" ]; then
    LAST_PASTE="$NEXT_PASTE"
    echo -n "$NEXT_PASTE" | ssh "$HOST" 'cat > ~/.remote-clipboard'
  fi
done
