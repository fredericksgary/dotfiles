#!/usr/bin/env bash

# Usage: whenchanged somefile a shell command

set -e

THE_PATH=$1
shift

exec 3<&0

(echo run it first; inotifywait \
                        -e modify \
                        -e attrib \
                        -e move \
                        -e create \
                        -e delete \
                        -e move_self \
                        -e delete_self \
                        -rm \
                        "$THE_PATH") |
    while true; do
        read EV
        # read all other available lines
        while read -t 0.01; do true; done
        # run the command
        "$@" < /dev/null || true
    done
