#!/usr/bin/env ruby

$prefix = ARGV[0]

def current_sha
  `git log --format="%H" -n 1`.strip
end

def last_msg
  lines = `git cat-file -p #{current_sha}`.split("\n").map(&:strip).drop(5)

  while(!lines.empty? && lines.last.empty?)
    lines.pop!
  end

  lines
end

while current_sha !~ /^#{$prefix}/
  puts "Didn't match: #{current_sha}"
  commit_lines = last_msg

  whitespace_line = ""
  64.times do
    whitespace_line << ["a","b"][rand(2)]
  end

  commit_lines << whitespace_line
  File.open("/tmp/defaced.txt",'w') do |f|
    commit_lines.each do |line|
      f.puts line
    end
  end

  `git commit --amend -F /tmp/defaced.txt`
end

puts "Done: #{current_sha}"